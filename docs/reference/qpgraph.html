<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Compute the fit of an admixture graph — qpgraph • admixtools</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>


<!-- docsearch -->
<script src="../docsearch.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous" />
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>


  
  <script src="../extra.js"></script>

<meta property="og:title" content="Compute the fit of an admixture graph — qpgraph" />
<meta property="og:description" content="Computes the fit of a given admixturegraph from f2-statistics. Drift edge weights and admixture edges weights are optimized until the (negative) likelihood score is minimized. The likelihood score is based on the squared difference between estimated and fitted f3-statistics." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9DRRL9PZD0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9DRRL9PZD0');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">admixtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/admixtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/fstats.html">f-statistics</a>
    </li>
    <li>
      <a href="../articles/graphs.html">Admixture graphs</a>
    </li>
    <li>
      <a href="../articles/io.html">Data formats</a>
    </li>
    <li>
      <a href="../articles/paper.html">Paper notes</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Parallelization</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting</a>
    </li>
    <li>
      <a href="../articles/qpadm.html">qpWave and qpAdm</a>
    </li>
    <li>
      <a href="../articles/resampling.html">Standard errors</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/uqrmaie1/admixtools/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
      <form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
        </div>
      </form>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Compute the fit of an admixture graph</h1>
    <small class="dont-index">Source: <a href='https://github.com/uqrmaie1/admixtools/blob/master/R/qpgraph.R'><code>R/qpgraph.R</code></a></small>
    <div class="hidden name"><code>qpgraph.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Computes the fit of a given admixturegraph from f2-statistics. Drift edge weights and admixture edges weights are optimized until the (negative) likelihood score is minimized. The likelihood score is based on the squared difference between estimated and fitted f3-statistics.</p>
    </div>

    <pre class="usage"><span class='fu'>qpgraph</span><span class='op'>(</span>
  <span class='va'>data</span>,
  <span class='va'>graph</span>,
  lambdascale <span class='op'>=</span> <span class='fl'>1</span>,
  boot <span class='op'>=</span> <span class='cn'>FALSE</span>,
  diag <span class='op'>=</span> <span class='fl'>1e-04</span>,
  diag_f3 <span class='op'>=</span> <span class='fl'>1e-05</span>,
  lsqmode <span class='op'>=</span> <span class='cn'>FALSE</span>,
  numstart <span class='op'>=</span> <span class='fl'>10</span>,
  seed <span class='op'>=</span> <span class='cn'>NULL</span>,
  cpp <span class='op'>=</span> <span class='cn'>TRUE</span>,
  return_fstats <span class='op'>=</span> <span class='cn'>FALSE</span>,
  return_pvalue <span class='op'>=</span> <span class='cn'>FALSE</span>,
  f3precomp <span class='op'>=</span> <span class='cn'>NULL</span>,
  f3basepop <span class='op'>=</span> <span class='cn'>NULL</span>,
  constrained <span class='op'>=</span> <span class='cn'>TRUE</span>,
  allsnps <span class='op'>=</span> <span class='cn'>FALSE</span>,
  ppinv <span class='op'>=</span> <span class='cn'>NULL</span>,
  f2_blocks_test <span class='op'>=</span> <span class='cn'>NULL</span>,
  verbose <span class='op'>=</span> <span class='cn'>FALSE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>data</th>
      <td><p>Input data in one of three forms:</p><ol>
<li><p>A 3d array of blocked f2 statistics, output of <code><a href='f2_from_precomp.html'>f2_from_precomp</a></code> or <code><a href='extract_f2.html'>extract_f2</a></code> (fastest option)</p></li>
<li><p>A directory which contains pre-computed f2-statistics</p></li>
<li><p>The prefix of genotype files (slowest option)</p></li>
</ol></td>
    </tr>
    <tr>
      <th>graph</th>
      <td><p>An admixture graph represented as a matrix of edges, an <code>igraph</code> object, or the path to a <em>qpGraph</em> graph file. Edges can be constrained by providing a matrix or data frame of edges with columns titled <code>lower</code> and <code>upper</code> with lower and upper bounds, respectively. By default, admixture edges are constrained to be between zero and one (with paired edges summing to one), and drift edges have a lower bound at zero.</p></td>
    </tr>
    <tr>
      <th>lambdascale</th>
      <td><p>Scales f2-statistics. This has no effect on the fit, but is used in the original <em>qpGraph</em> program to display branch weights on a scale that corresponds to FST distances.</p></td>
    </tr>
    <tr>
      <th>boot</th>
      <td><p>If <code>FALSE</code> (the default), each block will be left out at a time and the covariance matrix of
f3 statistics will be computed using block-jackknife. Otherwise bootstrap resampling is performed <code>n</code> times,
where <code>n</code> is either equal to <code>boot</code> if it is an integer, or equal to the number of blocks if <code>boot</code> is <code>TRUE</code>.
The covariance matrix of f3 statistics will be computed using bootstrap resampling.</p></td>
    </tr>
    <tr>
      <th>diag</th>
      <td><p>Regularization term added to the diagonal elements of the covariance matrix of fitted branch lengths (after scaling by the matrix trace). Default is 0.0001.</p></td>
    </tr>
    <tr>
      <th>diag_f3</th>
      <td><p>Regularization term added to the diagonal elements of the covariance matrix of estimated f3 statistics (after scaling by the matrix trace). In the original <em>qpGraph</em> program, this is fixed at 0.00001.</p></td>
    </tr>
    <tr>
      <th>lsqmode</th>
      <td><p>Least-squares mode. If <code>TRUE</code>, the likelihood score will be computed using a diagonal matrix with <code>1/(sum(diag(f3_var)) * diag_f3)</code>, in place of the inverse f3-statistic covariance matrix.</p>
<p><code>lsqmode = 2</code> will use the identity matrix instead, which is equivalent to computing the score as the sum of squared residuals (<code><a href='https://rdrr.io/r/base/sum.html'>sum((f3_est-f3_fit)^2)</a></code>).</p>
<p>Both of these options do not take the covariance of f3-statistics into account. This can lead to bias, but is more stable in cases where the inverse f3-statistics covariance matrix can not be estimated precisely (for example because the number of populations is large). An alternative to <code>lsqmode = TRUE</code> that doesn't completely ignore the covariance of f3-statistics is to increase <code>diag_f3</code>.</p></td>
    </tr>
    <tr>
      <th>numstart</th>
      <td><p>Number of random initializations of starting weights. Defaults to 10. Increasing this number will make the optimization slower, but reduce the risk of not finding the optimal weights. Check the <code>opt</code> output to see how much the optimization depends on the starting weights.</p></td>
    </tr>
    <tr>
      <th>seed</th>
      <td><p>Random seed for generating starting weights.</p></td>
    </tr>
    <tr>
      <th>cpp</th>
      <td><p>Use C++ functions. Setting this to <code>FALSE</code> will be slower but can help with debugging.</p></td>
    </tr>
    <tr>
      <th>return_fstats</th>
      <td><p>Return estimated and fitted f2- and f4-statistics, as well as the worst f4-statistic residual Z-score. Defaults to <code>FALSE</code> because this can be slow.</p></td>
    </tr>
    <tr>
      <th>f3precomp</th>
      <td><p>Optional precomputed f3-statistics. This should be the output of <code><a href='qpgraph_precompute_f3.html'>qpgraph_precompute_f3</a></code> and can be provided instead of <code>data</code>. This can speed things up if many graphs are evaluated using the same set of f3-statistics.</p></td>
    </tr>
    <tr>
      <th>f3basepop</th>
      <td><p>Optional f3-statistics base population. Inference will be based on f3-statistics of the form <code>f3(f3basepop; i, j)</code> for all population pairs <code>(i, j)</code>. Defaults to the outgroup population if the graph has one. This option is ignored if <code>f3precomp</code> is provided. Changing <code>f3basepop</code> should make very little difference.</p></td>
    </tr>
    <tr>
      <th>constrained</th>
      <td><p>Constrain estimated drift edge weights to be non-negative, and admixture edge weights to be between zero and one.</p></td>
    </tr>
    <tr>
      <th>allsnps</th>
      <td><p>Compute f3 from different SNPs for each population triplet (if data is missing for some SNPs and populations). This only has an effect when <code>data</code> is the prefix of genotype files.</p></td>
    </tr>
    <tr>
      <th>ppinv</th>
      <td><p>Optional inverse f3-statistics covariance matrix</p></td>
    </tr>
    <tr>
      <th>f2_blocks_test</th>
      <td><p>An optional 3d array of f2-statistics used for computing an out-of-sample score. This should contain only SNP blocks which are not part of <code>f2_blocks</code>. This allows to estimate the fit of a graph without overfitting and will not be used during the optimization step</p></td>
    </tr>
    <tr>
      <th>verbose</th>
      <td><p>Print progress updates</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p><code>qpgraph</code> returns a list with data describing the model fit:</p><ul>
<li><p><code>edges</code>: A data frame where each row is an edge in the graph. For regular edges,
the column <code>weight</code> is the estimated edge length, and for admixture edges, it is the estimated admixture weight.</p></li>
<li><p><code>score</code>: The likelihood score of the fitted graph. Lower values correspond to better fits.
The score is calculated as the inner product of the residuals (difference between estimated and
fitted f3 statistics), weighted by the inverse of the f3 covariance matrix. See <code>qpgraph_score</code></p></li>
<li><p><code>f2</code>: Estimated and fitted f2 statistics (if <code>return_fstats = TRUE</code>). p-values and z-scores test the significance of the difference.</p></li>
<li><p><code>f3</code>: Estimated and fitted f3 statistics. p-values and z-scores test the significance of the difference.</p></li>
<li><p><code>f4</code>: Estimated and fitted f4 statistics (if <code>return_fstats = TRUE</code>). p-values and z-scores test the significance of the difference.</p></li>
<li><p><code>opt</code>: A data frame with details of the weight-fitting step, including the randomly sampled starting weights. The column <code>value</code> contains the score for each set of starting weights. Columns starting with <code>x</code> denote initial weights, and columns starting with <code>y</code> denote fitted weights.</p></li>
<li><p><code>worst_residual</code>: The highest absolute z-score of f4-statistics residuals (fitted - estimated f4); (returned if <code>return_fstats = TRUE</code>)</p></li>
</ul>

    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Patterson, N. et al. (2012) <em>Ancient admixture in human history.</em> Genetics</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='qpgraph_wrapper.html'>qpgraph_wrapper</a></code> for a wrapper functions which calls the original <em>qpGraph</em> program.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='va'>out</span> <span class='op'>=</span> <span class='fu'>qpgraph</span><span class='op'>(</span><span class='va'>example_f2_blocks</span>, <span class='va'>example_graph</span><span class='op'>)</span>
<span class='fu'><a href='plot_graph.html'>plot_graph</a></span><span class='op'>(</span><span class='va'>out</span><span class='op'>$</span><span class='va'>edges</span><span class='op'>)</span>
</div><div class='img'><img src='qpgraph-1.png' alt='' width='700' height='433' /></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Robert Maier, Nick Patterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script>
<script>
  docsearch({
    
    
    apiKey: 'c30b6be96312414d83a0ba52b94b558b',
    indexName: 'admixtools',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>



  </body>
</html>


